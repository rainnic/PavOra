<!DOCTYPE html>
<html>
<!--
/*
* Project Name: Pavora
* Copyright (c) 2025 Nicola Rainiero
*
* This software is released under the MIT License.
* Please refer to the LICENSE file for the full license text.
*/
-->

<head>
  <base target="_top">
  <?!= HtmlService.createHtmlOutputFromFile('W_styleSheet').getContent(); ?>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <?!= HtmlService.createHtmlOutputFromFile('W_javaScript').getContent(); ?>
  <!-- da qui sotto si può copiare -->
  <script>
    // store in data the array in doGet
    var data = <?!= JSON.stringify(dataFromServerTemplate) ?>; //Stores the data directly in the javascript code
    const minutesPermitted = "<?= minutesPermitted ?>";

    // for multi language support
    const translationsString = <?= JSON.stringify(translations) ?>;
    const currentLanguage = "<?= currentLanguage ?>";

    // Deserializza la stringa JSON in un oggetto JavaScript
    const translations = JSON.parse(translationsString);

    // Funzione translate
    function translate(key, placeholders = {}) {
      // Dividi la chiave in livelli
      const keys = key.split('.');
      let translation = translations[currentLanguage];

      // Naviga nel dizionario
      for (const k of keys) {
        translation = translation?.[k];
        if (!translation) {
          return key; // Se una chiave non è trovata, restituisci la chiave originale
        }
      }

      // Sostituisci i placeholder dinamici
      Object.keys(placeholders).forEach(placeholder => {
        const regex = new RegExp(`\\{${placeholder}\\}`, 'g'); // Trova il placeholder
        translation = translation.replace(regex, placeholders[placeholder]);
      });
      return translation;
    }

    var typeEvData = data.shift();
    var refOpData = data.shift();
    var refComData = data.shift();
    var allestitoreData = data.shift();
    var cateringData = data.shift();
    var startDate = data.shift();
    var finishDate = data.shift();
    var eventList = data.shift();
    document.getElementById("name").value = eventList[0][0];
    // sample usage
    function initialize() {
    }
    // use onload or use jquery to call your initialization after the document loads
    window.onload = initialize;
  </script>

  <style>
    #update {
      visibility: hidden;
    }
  </style>

</head>

<script>
  function reloadFunct() {
    var firstChanged = document.getElementById("startDate").value;
    var lastChanged = document.getElementById("finishDate").value;
    var selectedStartDate = new Date(firstChanged);
    var selectedFinishDate = new Date(lastChanged);
    var originalStartDate = new Date(startDate);
    var originalFinishDate = new Date(finishDate);
    if ((selectedStartDate < originalStartDate) || (selectedFinishDate > originalFinishDate)) {
      document.getElementById("reloadStruct").style.display = "block";
      document.getElementById("copyStruct").style.display = "block";
      document.getElementById("back").style.display = "block";
      document.getElementById("standardForm").style.display = "none";
    } else {
      alert(translate('modifyPageAsk.useMinusButton'));
      buttonClickFunctionBack();
    }
  }

  function findKey(key, array, pos) {
    var index = -1;
    for (let i = 0, len = array.length; i < len; i++) {
      if (array[i][pos] === key) {
        index = i;
        break;
      }
    }
    if (index > -1) {
      return index
    } else { return index = -1 }
  }

  function runFunc() {

    var first = document.getElementById("startDate").value;
    var last = document.getElementById("finishDate").value;

    var opz = document.getElementById("opz").value;
    var opzExp = document.getElementById("opzExp").value;

    var selectedStartDate = new Date(first);
    var selectedFinishDate = new Date(last);

    // Flag per il controllo degli errori
    var hasError = false;

    // Controllo date evento
    if (selectedFinishDate < selectedStartDate) {
      alert(translate('alertHtml.messageDate'));
      document.getElementById("finishDate").value = ''; // Resetta il valore
      hasError = true;
    }

    // Controllo date evento per non superare le 24 ore
    if ((selectedFinishDate.getTime() - selectedStartDate.getTime()) >= (1 * 24 * 60 * 60 * 1000)) {
      alert(translate('hourMenuPage.extraTime'));
      document.getElementById("finishDate").value = ''; // Resetta il valore
      hasError = true;
    }

    // Controllo scadenza opzione
    if ((opz === "SI")||(opz === "OFF")) {
      if (!opzExp) {
        alert(translate('addEventPage.opzExpAlert'));
        hasError = true;
      } else {
        var selectedOpzExp = new Date(opzExp);
        var today = new Date();        
        if (selectedOpzExp >= selectedStartDate) {
          alert(translate('addEventPage.opzExpDateAlert'));
          document.getElementById("opzExp").value = ''; // Resetta il valore
          hasError = true;
        } else if (selectedOpzExp <= today) {
          alert(translate('addEventPage.opzExpTodayAlert'));
          document.getElementById("opzExp").value = ''; // Resetta il valore
          hasError = true;
        }
      }
    }

    // Altri controlli
    if (!hasError) {
      var selectElementQ = document.getElementById('quartiere');
      var selectElementC = document.getElementById('congress');
      var selectElementI = document.getElementById('ingressi');
      var selectElementA = document.getElementById('aree');
      var selectElementP = document.getElementById('parcheggi');

      var selectedValuesQ = Array.from(selectElementQ.selectedOptions, (option) => option.value);
      var selectedValuesC = Array.from(selectElementC.selectedOptions, (option) => option.value);
      var selectedValuesI = Array.from(selectElementI.selectedOptions, (option) => option.value);
      var selectedValuesA = Array.from(selectElementA.selectedOptions, (option) => option.value);
      var selectedValuesP = Array.from(selectElementP.selectedOptions, (option) => option.value);

      var finalStructs = selectedValuesQ.concat(selectedValuesC, selectedValuesI, selectedValuesA, selectedValuesP).filter(x => x);

      if ((selectedValuesQ.length == 0) && (selectedValuesC.length == 0)) {
        alert(translate('addEventPage.justQorCC'));
        hasError = true;
      } else if (selectedValuesI.length == 0 && document.getElementById("typeEv").value !== 'lav' && document.getElementById("opz").value !== 'OFF') {
        alert(translate('addEventPage.oneGate'));
        hasError = true;
      }
    }

    // Se non ci sono errori, procedi con il submit
    if (!hasError) {
      varDef = document.getElementById("idEvent").value;
      var first = document.getElementById("startDate").value;
      var last = document.getElementById("finishDate").value;
      if (varDef.length == 0) { // === 'undefined' == null
        var eventID = document.getElementById("nameOriginal").value;
        //eventID = eventList[0][0]; // original name of the event!!
        //console.log('IDd evento diventa ' + eventID);
        var first = document.getElementById("startDate").value;
        var last = document.getElementById("finishDate").value;
      } else {
        eventID = document.getElementById("idEvent").value;
        //eventID = document.getElementById("name").value;
      }      
      listEvents = submit();
      var eventi = document.getElementById("output");
      var outputEvents = eventi.innerHTML;
      if (listEvents.length > 0) {
        var matrix = stringToMatrix(outputEvents, 8);
        var testoEventi = translate('addEventPage.infoOutTitle');
        var testoEventi = testoEventi + translate('addEventPage.infoOutLabel');
        for (let i = 0; i < matrix.length; i++) {
          testoEventi = testoEventi + "•" + formatDate(matrix[i][1]).giorno + "      " + matrix[i][0] + "   " + formatDate(matrix[i][1]).ora + "   " + formatDate(matrix[i][2]).ora + "\n";
        }
        testoEventi = testoEventi + translate('addEventPage.infoOutDesc') + matrix[0][3];
        testoEventi = testoEventi + translate('addEventPage.infoOutWhere') + matrix[0][4];
        testoEventi = testoEventi + translate('addEventPage.infoOutQuest');

        if (confirm(testoEventi)) {

          const button = document.getElementById('update');
          button.disabled = true;
          button.innerText = translate('viewCalendarPage.waitTr');

          // Simula un lavoro con setTimeout
          setTimeout(() => {
            button.disabled = false;
            button.innerText = translate('viewCalendarPage.goButtonTr');
            //alert("Operazione completata!");
          }, 20000);

          //google.script.run.createEvents(first, last, outputEvents);
          //google.script.run.deleteThenModifyEvents(eventID, first, last, outputEvents, 'hall');
          google.script.run
             .withSuccessHandler(onSalvataggioCompletato)
             .deleteThenModifyEvents(eventID, first, last, outputEvents, 'hall');
        }
      }
    }
  }

function onSalvataggioCompletato(risultato) {
  if (!risultato || risultato.success !== true) {
    // sidebar resta aperta
    return;
  }
  google.script.host.close();
}

  function cancella() {
    varDef = document.getElementById("idEvent").value;
    var first = document.getElementById("startDate").value;
    var last = document.getElementById("finishDate").value;
    if (varDef.length == 0) { // === 'undefined' == null
      var eventID = document.getElementById("nameOriginal").value;
      var first = document.getElementById("startDate").value;
      var last = document.getElementById("finishDate").value;
    } else {
      eventID = document.getElementById("idEvent").value;
    }

    const button = document.getElementById('deleteButton');
    button.disabled = true;
    button.innerText = translate('viewCalendarPage.waitTr');

    // Simula un lavoro con setTimeout
    setTimeout(() => {
      button.disabled = false;
      button.innerText = translate('modifyPageAsk.deleteEvent');
      //alert("Operazione completata!");
    }, 20000);

    //google.script.run.deleteEvents(eventID, first, last, 'hall');
    google.script.run
        .withSuccessHandler(onSalvataggioCompletato)
        .deleteEvents(eventID, first, last, 'hall');

  }
  function back() {
    //google.script.run.manageSmallRoom()
    google.script.host.close();
  }    
</script>

<!-- <body> -->

<body onload="createTable()" class="specialDaily-page">
  <!-- <?!= HtmlService.createHtmlOutputFromFile('W_header').getContent(); ?> -->
  <!-- <h3 class="align ">Visualizza gli eventi a calendario</h3> -->
  <h4 class="align">
    <?= translate('modifyPageAsk.dateChangeEvent') ?>
  </h4>
  <form id="myForm" onsubmit="runFunc()">
    <div class="row mb-3">
      <label for="startDate" class="col-sm-2 col-form-label">
        <?= translate('viewCalendarPage.startDateTr') ?>
      </label>
      <div class="col-sm-10">
        <!-- disabled="true" -->
        <input required type="datetime-local" onchange="reloadFunct();" data-date-format="dd/mm/yyyy"
          class="form-control form-control-lg" value="" name="startDate" id="startDate" placeholder="Inizio">
      </div>
    </div>
    <div class="row mb-3">
      <label for="finishDate" class="col-sm-2 col-form-label">
        <?= translate('viewCalendarPage.endDateTr') ?>
      </label>
      <div class="col-sm-10">
        <!-- disabled="true" -->
        <input required type="datetime-local" onchange="reloadFunct();" data-date-format="dd/mm/yyyy"
          class="form-control form-control-lg" value="" name="finishDate" id="finishDate" placeholder="Fine">
      </div>
    </div>
    <div id="standardForm" style="display: block;">

      <div class="row mb-3">
        <label for="name" class="col-sm-2 col-form-label">
          <?= translate('addEventPage.eventName') ?>
        </label>
        <div class="col-sm-10">
          <input required onchange="toggleUpdateButton()" type="text" class="form-control form-control-lg" value=""
            name="name" id="name" placeholder="<?= translate('addEventPage.eventName') ?>">
        </div>
      </div>

      <div class="row mb-3">
        <label for="opz" class="col-sm-2 col-form-label">
          <?= translate('addEventPage.isDefined') ?>
        </label>
        <div class="col-sm-10">
          <select required class="form-control form-control-lg" name="opz" id="opz"
            onchange="handleOptionChange(); toggleUpdateButton()">
            <option disabled selected value>
              <?= translate('addEventPage.chooseList') ?>
            </option>
            <option value='OFF'><?= translate('addEventPage.offer') ?> </option> <!-- Offerta -->
            <option value='SI'><?= translate('addEventPage.option') ?></option> <!-- Opzione o NO-->
            <option value='NO'>
              <?= translate('addEventPage.confirmed') ?> <!-- Confermato o SI -->
            </option>

          </select>
        </div>
      </div>

      <!-- Expiration date for pending Event -->
      <div class="row mb-3" id="opzExpContainer" style="display: none;">
        <label for="opzExp" class="col-sm-2 col-form-label">
          <?= translate('addEventPage.opzExpTitle') ?>
        </label>
        <div class="col-sm-10">
          <input type="date" class="form-control form-control-lg" id="opzExp" name="opzExp" value=""
            placeholder="dd/mm/yyyy" data-date-format="dd/mm/yyyy" onchange="toggleUpdateButton()">
        </div>
      </div>

      <div class="row mb-3">
        <label for="color" class="col-sm-2 col-form-label">
          <?= translate('addEventPage.colorCalendar') ?>
        </label>
        <div class="col-sm-10">
          <select onchange="this.className=this.options[this.selectedIndex].className; toggleUpdateButton()"
            class="whiteText form-control form-control-lg" name="color" id="color">
            <option class="whiteText" selected value="nessuno">
              <?= translate('addEventPage.colNotSpec') ?>
            </option>
            <option class="redText" value="rosso">
              <?= translate('addEventPage.colRed') ?>
            </option>
            <option class="greenText" value="verde">
              <?= translate('addEventPage.colGreen') ?>
            </option>
            <option class="greenLightText" value="verdeChiaro">
              <?= translate('addEventPage.colLGreen') ?>
            </option>
            <option class="redLightText" value="rossoChiaro">
              <?= translate('addEventPage.colLRed') ?>
            </option>
            <option class="purpleText" value="viola">
              <?= translate('addEventPage.colViolet') ?>
            </option>
          </select>
        </div>
      </div>

      <div class="row mb-3">
        <label for="public" class="col-sm-2 col-form-label">
          <?= translate('addEventPage.isOpen') ?>
        </label>
        <div class="col-sm-10">
          <select required class="form-control form-control-lg" name="public" id="public"
            onchange="toggleUpdateButton()">
            <option disabled selected value>
              <?= translate('addEventPage.chooseList') ?>
            </option>
            <option value='SI'>
              <?= translate('addEventPage.chooseYes') ?>
            </option>
            <option value='NO'>NO</option>
          </select>
        </div>
      </div>

      <h6>
        <?= translate('addEventPage.selectStruc') ?>
      </h6>
      <div class="row mb-3" id="mainStructs">
        <div class="col-sm-10">
          <label>
            <?= translate('addEventPage.selQcenter') ?>
          </label><br />
          <select style="width: 100%;" id="quartiere" onchange="toggleUpdateButton()" multiple multiselect-search="true"
            multiselect-select-all="true" multiselect-hide-x="true" multiselect-max-items="10">
          </select>
          <label>
            <?= translate('addEventPage.selCcenter') ?>
          </label><br />
          <select style="width: 100%;" id="congress" onchange="toggleUpdateButton()" multiple multiselect-search="true"
            multiselect-select-all="true" multiselect-hide-x="true" multiselect-max-items="10">
          </select>
          <label>
            <?= translate('addEventPage.selGService') ?>
          </label><br />
          <select style="width: 100%;" id="ingressi" onchange="toggleUpdateButton()" multiple multiselect-search="true"
            multiselect-select-all="true" multiselect-hide-x="true" multiselect-max-items="10">
          </select>
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-sm-10">
          <label>
            <?= translate('addEventPage.selAreas') ?>
          </label><br />
          <select style="width: 100%;" id="aree" onchange="toggleUpdateButton()" multiple multiselect-search="true"
            multiselect-select-all="true" multiselect-hide-x="true" multiselect-max-items="10">
          </select>
          <label>
            <?= translate('addEventPage.selParkEvent') ?>
          </label><br />
          <select style="width: 100%;" id="parcheggi" onchange="toggleUpdateButton()" multiple multiselect-search="true"
            multiselect-select-all="true" multiselect-hide-x="true" multiselect-max-items="10">
          </select>
        </div>
      </div>

      <div class="row mb-3">
        <label for="org" class="col-sm-2 col-form-label">
          <?= translate('addEventPage.selOrganizer') ?>
        </label>
        <div class="col-sm-10">
          <input required onchange="toggleUpdateButton()" type="text" class="form-control form-control-sm" value=""
            name="org" id="org" placeholder="<?= translate('addEventPage.placeNameOrganizer') ?>">
        </div>
      </div>

      <div class="row mb-3">
        <label for="org" class="col-sm-2 col-form-label">
          <?= translate('addEventPage.eventCode') ?>
        </label>
        <div class="col-sm-10">
          <input onchange="toggleUpdateButton()" type="text" class="form-control form-control-sm" value="" name="code"
            id="code" placeholder="<?= translate('addEventPage.placeCode') ?>">
        </div>
      </div>

      <div class="row mb-3">
        <label for="typeEv" class="col-sm-2 col-form-label">
          <?= translate('addEventPage.typeEvent') ?>
        </label>
        <div class="col-sm-10">
          <select required class="form-control form-control-lg" name="typeEv" id="typeEv"
            onchange="document.getElementById('update').style.visibility = 'visible'">
            <option disabled selected value>
              <?= translate('addEventPage.chooseList') ?>
            </option>
          </select>
        </div>
      </div>

      <div class="row mb-3">
        <label for="refCom" class="col-sm-2 col-form-label">
          <?= translate('addEventPage.refCom') ?>
        </label>
        <div class="col-sm-10">
          <select required class="form-control form-control-lg" name="refCom" id="refCom"
            onchange="document.getElementById('update').style.visibility = 'visible'">
            <option disabled selected value>
              <?= translate('addEventPage.chooseList') ?>
            </option>
          </select>
        </div>
      </div>

      <div class="row mb-3">
        <label for="refOp" class="col-sm-2 col-form-label">
          <?= translate('addEventPage.refOp') ?>
        </label>
        <div class="col-sm-10">
          <select required class="form-control form-control-lg" name="refOp" id="refOp"
            onchange="document.getElementById('update').style.visibility = 'visible'">
            <option disabled selected value>
              <?= translate('addEventPage.chooseList') ?>
            </option>
          </select>
        </div>
      </div>

      <div class="row mb-3">
        <label for="allestitore" class="col-sm-2 col-form-label">
          <?= translate('addEventPage.standFitter') ?>
        </label>
        <div class="col-sm-10">
          <select required class="form-control form-control-lg" name="allestitore" id="allestitore"
            onchange="document.getElementById('update').style.visibility = 'visible'">
            <option disabled selected value>
              <?= translate('addEventPage.chooseList') ?>
            </option>
          </select>
        </div>
      </div>

      <div class="row mb-3">
        <label for="catering" class="col-sm-2 col-form-label">
          <?= translate('addEventPage.catering') ?>
        </label>
        <div class="col-sm-10">
          <select required class="form-control form-control-lg" name="catering" id="catering"
            onchange="document.getElementById('update').style.visibility = 'visible'">
            <option disabled selected value>
              <?= translate('addEventPage.chooseList') ?>
            </option>
          </select>
        </div>
      </div>

      <div class="row mb-3">
        <label for="note" class="col-sm-2 col-form-label">
          <?= translate('addEventPage.details') ?>
        </label>
        <div class="col-sm-10">
          <input onchange="toggleUpdateButton()" type="text" class="form-control form-control-lg" value="" name="note"
            id="note" placeholder="<?= translate('addEventPage.placeDetails') ?>">
        </div>
      </div>

      <div class="row mb-3">
        <!-- Display the total square meter and seating capacity -->
        <div class="col-sm-10">
          <input type="text" disabled="true" id="sums" class="form-control form-control-sm"
            placeholder="<?= translate('addEventPage.placeSqPax') ?>">
        </div>
      </div>

      <div class="row mb-3">
        <!-- Display the ID -->
        <div class="col-sm-10">
          <input type="text" disabled="true" id="idEvent" class="form-control form-control-sm"
            placeholder="<?= translate('modifyPageAsk.displayIDCode') ?>">
        </div>
      </div>

      <div class="row mb-3">
        <!-- Display the original name -->
        <div class="col-sm-10">
          <input type="text" disabled="true" id="nameOriginal" class="form-control form-control-sm"
            placeholder="<?= translate('modifyPageAsk.nameOrEvent') ?>">
        </div>
      </div>

      <div class="row mb-3">
        <label for="vvf" class="col-sm-2 col-form-label">
          <?= translate('addEventPage.vvf') ?>
        </label>
        <div class="col-sm-10">
          <select required class="form-control form-control-lg" name="vvf" id="vvf" onchange="toggleUpdateButton()">
            <option disabled selected value>
              <?= translate('addEventPage.chooseList') ?>
            </option>
            <option disabled="true" value='CPVLPS'>
              <?= translate('addEventPage.CPVLPS') ?>
            </option>
            <option disabled="true" value='SI'>
              <?= translate('addEventPage.mandatory') ?>
            </option>
            <option disabled="true" value='NO'>
              <?= translate('addEventPage.notMandatory') ?>
            </option>
            <option value='Richiesto'>
              <?= translate('addEventPage.reqByOrg') ?>
            </option>
          </select>
        </div>
      </div>

      <div class="row mb-3">
        <label for="cri" class="col-sm-2 col-form-label">
          <?= translate('addEventPage.presCRI') ?>
        </label>
        <div class="col-sm-10">
          <select required class="form-control form-control-lg" name="cri" id="cri" onchange="toggleUpdateButton()">
            <option disabled selected value>
              <?= translate('addEventPage.chooseList') ?>
            </option>
            <option disabled="true" value='CPVLPS'>
              <?= translate('addEventPage.CPVLPS') ?>
            </option>
            <option disabled="true" value='SI'>
              <?= translate('addEventPage.mandatory') ?>
            </option>
            <option disabled="true" value='NO'>
              <?= translate('addEventPage.notMandatory') ?>
            </option>
            <option value='Richiesto'>
              <?= translate('addEventPage.reqByOrg') ?>
            </option>
          </select>
        </div>
      </div>

      <h6>
        <?= translate('addEventPage.defAllDay') ?>
      </h6>
      <div class="row mb-3">
        <div class="col-sm-10">
          <div id="cont"></div> <!-- the container to add the TABLE -->
        </div>
      </div>

      <div class="button-container">
        <div id="message" style="display: block;"></div>
        <button type="submit" class="align" id="update">
          <?= translate('modifyPageAsk.editEvent') ?>
        </button>
        <button id="deleteButton" onclick="cancella()">
    <?= translate('modifyPageAsk.deleteEvent') ?>
</button>

<button id="noteButton" class="action" onclick="handleNoteClick()">
    <?= translate('modifyPageAsk.changeEvent') ?>
</button>
      </div>
    </div>
  </form>
  <!-- Se cambio le date iniziali -->
  <div id="messageDate" style="display: block;"></div>
  <div class="button-container">  
  <button id="reloadStruct" style="display: none;">
    <?= translate('addEventPage.findNewTime') ?>
  </button>
  </button>
    <button id="copyStruct" style="display: none;">
    <?= translate('addEventPage.copyStruct') ?>
  </button>
  <button id="back" style="display: none;">
    <?= translate('modifyPageAsk.comeBack') ?>
  </button>
  </div>
  <!-- Div per visualizzare il countdown -->
  <div id="countdown">
    <?= translate('addEventPage.timeElapsed') ?><span id="timeElapsed"></span>
  </div>

  <div id='output'></div>
</body>
<script>

  // Script for expiration date
// function handleOption()

  // Script per il countdown
  let timeLeft = (minutesPermitted - 5) * 60; // in seconds

  function updateCountdown() {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;

    document.getElementById("timeElapsed").textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
    timeLeft--;

    // Cambia il colore del countdown in base al tempo rimanente
    if (timeLeft <= 5 * 60) { // Da -5 a 0 minuti
      document.getElementById("countdown").style.backgroundColor = "red";
    }

    if (timeLeft < 0) {
      // Reindirizza alla pagina finale se il tempo è scaduto
      // window.location.href = "pagina_finale.html";
      //google.script.run.completeMenu();
      google.script.host.close();
    }
  }

  setInterval(updateCountdown, 1000); // Aggiorna il countdown ogni secondo

  // Function to clear localStorage
  function clearLocalStorage() {
    localStorage.removeItem('startDate');
    localStorage.removeItem('finishDate');
  }

  function handleNoteClick() {
    const button = document.getElementById('noteButton');

    // Cambia il testo e disabilita il pulsante
    button.value = translate('viewCalendarPage.waitTr');
    button.disabled = true;

    // Timer per riattivare il pulsante dopo 30 secondi
    setTimeout(() => {
      button.value = translate('modifyPageAsk.changeEvent');
      button.disabled = false;
    }, 20000); // 60 secondi in millisecondi

    // Qui puoi inserire il codice per la funzione `loadNote()` o chiamarla direttamente
    loadNote();
  }

  function loadNote() {
    var first = document.getElementById("startDate").value;
    var last = document.getElementById("finishDate").value;
    google.script.run.withSuccessHandler(function (note) {
    }).getCellHallNote(first, 'hall');
  }

  function toggleUpdateButton() {
    document.getElementById('update').style.visibility = 'visible';
  }

  /* VARIABILI PER INIZIALIZZARE LA PAGINA */
  document.getElementById('startDate').value = formatDate(startDate).giornoOra;
  document.getElementById('finishDate').value = formatDate(finishDate).giornoOra;
  document.getElementById("name").value = eventList[0][0];
  document.getElementById("nameOriginal").value = eventList[0][0];
  document.getElementById("opz").value = eventList[0][1];
  document.getElementById("public").value = eventList[0][2];
  document.getElementById("allestitore").value = eventList[0][8];
  document.getElementById("vvf").value = eventList[0][9];
  document.getElementById("cri").value = eventList[0][10];
  document.getElementById("refCom").value = eventList[0][11];
  document.getElementById("refOp").value = eventList[0][21];
  document.getElementById("typeEv").value = eventList[0][23];
  document.getElementById("color").value = eventList[0][24];
  document.getElementById("catering").value = eventList[0][25];
  document.getElementById("code").value = eventList[0][26];
  document.getElementById("opzExp").value = eventList[0][27];
  document.getElementById("note").value = eventList[0][12];
  document.getElementById("org").value = eventList[0][22];
  document.getElementById("idEvent").value = eventList[0][13];

  // Put here the functions you want to execute after the DOM was loaded
  document.addEventListener("DOMContentLoaded", function () {
    handleOptionChange();
    updateSumsInput();
  });

  //startDateInput.addEventListener('onchange', handleStartDateChange);

  // Attach the event listener
  //document.getElementById('startDate').value.addEventListener('onchange', reloadStructures);
  //document.getElementById('finishDate').value.addEventListener('onchange', reloadStructures);

  function buttonClickFunction() {
    //alert("The button was clicked!");
    var first = document.getElementById("startDate").value;
    var last = document.getElementById("finishDate").value;

    var selectedStartDate = new Date(first);
    var selectedFinishDate = new Date(last);
    if (selectedFinishDate < selectedStartDate) {
      alert(translate('alertHtml.messageDate'));
      $(document).ready(function () {
        //$("#messageDate").html("La data deve essere successiva a quella iniziale!").show(); // .fadeOut(5000)
        $("#finishDate").value('');
      });
    } else if ((selectedFinishDate.getTime() - selectedStartDate.getTime()) >= (1 * 24 * 60 * 60 * 1000 - 30 * 60 * 1000)) {
      alert(translate('hourMenuPage.extraTime'));
      $(document).ready(function () {
        //$("#messageDate").html("L'evento non può durare più di un giorno!").show(); // .fadeOut(5000)
        $("#finishDate").value('');
      });
    } else {
      varDef = document.getElementById("idEvent").value;
      if (varDef.length == 0) { // === 'undefined' == null
        var eventNameId = document.getElementById("nameOriginal").value;
      } else {
        var eventNameId = document.getElementById("idEvent").value;
      }
      var location = eventList[0][20];
      var quartiere = multiSelect2string(document.getElementById('quartiere'));
      var congress = multiSelect2string(document.getElementById('congress'));
      var ingressi = multiSelect2string(document.getElementById('ingressi'));
      var aree = multiSelect2string(document.getElementById('aree'));
      var parcheggi = multiSelect2string(document.getElementById('parcheggi'));
      var locationArray = quartiere.concat(congress, ingressi, aree, parcheggi)
      var location = locationArray.join(',');
      //console.log(' -- '+startDate+' -- '+ finishDate+' -- '+ eventNameId+' -- '+ first+' -- '+ last+' -- '+ location);
      google.script.run.changeTimeHall(startDate, finishDate, eventNameId, first, last, location)
    }
  }

  function buttonClickFunctionCopy() {
    //alert("The button was clicked!");
    var first = document.getElementById("startDate").value;
    var last = document.getElementById("finishDate").value;

    var selectedStartDate = new Date(first);
    var selectedFinishDate = new Date(last);
    if (selectedFinishDate < selectedStartDate) {
      alert(translate('alertHtml.messageDate'));
      $(document).ready(function () {
        //$("#messageDate").html("La data deve essere successiva a quella iniziale!").show(); // .fadeOut(5000)
        $("#finishDate").value('');
      });
    } else {
      //google.script.run.showFreeStruct(first, last)
      varDef = document.getElementById("idEvent").value;
      if (varDef.length == 0) { // === 'undefined' == null
        var eventNameId = document.getElementById("nameOriginal").value;
      } else {
        var eventNameId = document.getElementById("idEvent").value;
      }
      /*
      finalArray = submit();
      var checkEvent = 0;
      for (let i = 0; i < finalArray.length; i++) {
        if ((finalArray[i][2] == 'E') || (finalArray[i][2] == 'L')) {
          checkEvent = 1;
        }
        var locationArray = (((finalArray[i][2] == 'E') || (finalArray[i][2] == 'L')) ? quartiere.concat(congress, ingressi, aree, parcheggi) : quartiere.concat(congress, ingressi, aree));
        var location = locationArray.join('| ');
        */
      //var location = eventList[0][20];
      var quartiere = multiSelect2string(document.getElementById('quartiere'));
      var congress = multiSelect2string(document.getElementById('congress'));
      var ingressi = multiSelect2string(document.getElementById('ingressi'));
      var aree = multiSelect2string(document.getElementById('aree'));
      var parcheggi = multiSelect2string(document.getElementById('parcheggi'));
      var locationArray = quartiere.concat(congress, ingressi, aree, parcheggi)
      var location = locationArray.join(',');


    const buttonCopy = document.getElementById('copyStruct');
    
    // Cambia il testo e disabilita il pulsante
    buttonCopy.value = translate('viewCalendarPage.waitTr');
    buttonCopy.disabled = true;
    
    // Timer per riattivare il pulsante dopo 30 secondi
    setTimeout(() => {
      buttonCopy.value = translate('addEventPage.copyStruct');
      buttonCopy.disabled = false;
    }, 20000); // 60 secondi in millisecondi


      console.log(' -- '+startDate+' -- '+ finishDate+' -- '+ eventNameId+' -- '+ first+' -- '+ last+' -- '+ location);
      //google.script.run.changeTime(startDate, finishDate, eventNameId, first, last, location)
      //alert("Working in progress!!");
      google.script.run.copyEventNew(startDate, finishDate, eventNameId, first, last, location)
    }
  }

  function buttonClickFunctionBack() {
    document.getElementById('startDate').value = formatDate(startDate).giornoOra;
    document.getElementById('finishDate').value = formatDate(finishDate).giornoOra;
    document.getElementById("reloadStruct").style.display = "none";
    document.getElementById("copyStruct").style.display = "none";
    document.getElementById("back").style.display = "none";
    document.getElementById("standardForm").style.display = "block";
  }

  var myButton = document.getElementById('reloadStruct');
  myButton.addEventListener('click', buttonClickFunction);
  var myButtonCopy = document.getElementById('copyStruct');
  myButtonCopy.addEventListener('click', buttonClickFunctionCopy);  
  var myButton1 = document.getElementById('back');
  myButton1.addEventListener('click', buttonClickFunctionBack);
  // FINE SE CAMBIO LE DATE INIZIALI

  // Per settare le option di CRI E VVF

  var areaSelect = document.getElementById('quartiere');
  var paxSelect = document.getElementById('congress');
  var vvfSelect = document.getElementById('vvf');
  var criSelect = document.getElementById('cri');
  var sumsInput = document.getElementById('sums');
  var public = document.getElementById('public');
  var typeEv = document.getElementById("typeEv");

  function updateSumsInput() {
    var selectedMqValues = areaSelect.selectedOptions;
    var selectedPaxValues = paxSelect.selectedOptions;
    sumsInput.value = '';

    for (let i = 0; i < selectedMqValues.length; i++) {
      if (i > 0) {
        sumsInput.value += ',';
      }
      sumsInput.value += selectedMqValues[i].value;
    }

    if ((selectedMqValues.length > 0) && (selectedPaxValues.length > 0)) {
      sumsInput.value += ',';
    }

    for (let i = 0; i < selectedPaxValues.length; i++) {
      if (i > 0) {
        sumsInput.value += ',';
      }
      sumsInput.value += selectedPaxValues[i].value;
    }

    var sumMq = 0;
    var sumPax = 0;
    var valuesArray = sumsInput.value.split(',');
    for (let i = 0; i < valuesArray.length; i++) {
      if (findKey(valuesArray[i], data, 0) >= 0) {
        sumMq += parseInt(data[findKey(valuesArray[i], data, 0)][3]);
        sumPax += parseInt(data[findKey(valuesArray[i], data, 0)][4]);
      }
    }

    //sumsInput.value += ' ( ' + sumMq + ' mq | ' + sumPax + ' pax)';
    sumsInput.value = ' ( ' + sumMq + ' mq | ' + sumPax + ' pax)'; // solo ma e pax

    // Update cri2Select based on sum
    if (((sumMq > 4000) || (sumPax > 1000)) && (public.value == 'SI')) {
      criSelect.value = ((criSelect.value == 'NI') ? 'NI' : 'SI');
      vvfSelect.value = ((vvfSelect.value == 'NI') ? 'NI' : 'SI');
    } else {
      criSelect.value = ((criSelect.value == 'NI') ? 'NI' : 'NO');
      vvfSelect.value = ((vvfSelect.value == 'NI') ? 'NI' : 'NO');
    }

    if (typeEv.value === 'concerto') {
      vvfSelect.value = 'CPVLPS';
      criSelect.value = "CPVLPS";
    }

  }


  areaSelect.addEventListener('change', updateSumsInput);
  public.addEventListener('change', updateSumsInput);
  paxSelect.addEventListener('change', updateSumsInput);

  // Fine per settare CRI e VVF

  // Per leggere le variabili importante da google sheet --> refOp, refCom, allestitore

  var typeEv = document.getElementById("typeEv");
  //console.log('La lunghezza di typeEV è'+typeEvData.length)
  for (let i = 0; i < typeEvData.length; i++) {
    //console.log('-->'+typeEvData[i][1]+' '+typeEvData[i][0]);
    var option = document.createElement("option");
    option.value = typeEvData[i][1];
    option.text = typeEvData[i][0];
    // Se il valore dell'opzione è nell'array selectedValues, impostalo come selezionato
    if (eventList[0][23].includes(typeEvData[i][1])) {
      option.selected = true;
    }
    if (!typeEvData[i][2]) { option.disabled = true; };
    typeEv.appendChild(option);
  }

  var refCom = document.getElementById("refCom");
  for (let i = 0; i < refComData.length; i++) {
    var option = document.createElement("option");
    option.value = refComData[i][1];
    option.text = refComData[i][0];
    // Se il valore dell'opzione è nell'array selectedValues, impostalo come selezionato
    if (eventList[0][11].includes(refComData[i][1])) {
      option.selected = true;
    }
    if (!refComData[i][2]) { option.disabled = true };
    refCom.appendChild(option);
  }

  var refOp = document.getElementById("refOp");
  for (let i = 0; i < refOpData.length; i++) {
    var option = document.createElement("option");
    option.value = refOpData[i][1];
    option.text = refOpData[i][0];
    // Se il valore dell'opzione è nell'array selectedValues, impostalo come selezionato
    if (eventList[0][21].includes(refOpData[i][1])) {
      option.selected = true;
    }
    if (!refOpData[i][2]) { option.disabled = true };
    refOp.appendChild(option);
  }

  var allestitore = document.getElementById("allestitore");
  for (let i = 0; i < allestitoreData.length; i++) {
    var option = document.createElement("option");
    option.value = allestitoreData[i][1];
    option.text = allestitoreData[i][0];
    // Se il valore dell'opzione è nell'array selectedValues, impostalo come selezionato
    if (eventList[0][8].includes(allestitoreData[i][1])) {
      option.selected = true;
    }
    if (!allestitoreData[i][2]) { option.disabled = true };
    allestitore.appendChild(option);
  }

  var catering = document.getElementById("catering");
  for (let i = 0; i < cateringData.length; i++) {
    var option = document.createElement("option");
    option.value = cateringData[i][1];
    option.text = cateringData[i][0];
    // Se il valore dell'opzione è nell'array selectedValues, impostalo come selezionato
    if (eventList[0][25].includes(cateringData[i][1])) {
      option.selected = true;
    }
    if (!cateringData[i][2]) { option.disabled = true };
    catering.appendChild(option);
  }

  // Per leggere le strutture importate da google sheet
  // Load quartiere data[i][2]==1
  var quartiere = document.getElementById("quartiere");
  for (let i = 0; i < data.length; i++) {
    var option = document.createElement("option");
    if ((data[i][2] == 1) && (data[i][6] == 1)) {
      option.value = data[i][0];
      option.text = data[i][1];
      // Se il valore dell'opzione è nell'array selectedValues, impostalo come selezionato
      if (eventList[0][3].includes(data[i][0])) {
        option.selected = true;
      }
      quartiere.appendChild(option);
    }
  }
  // Load Centro Congressi data[i][2]==2
  var congress = document.getElementById("congress");
  for (let i = 0; i < data.length; i++) {
    var option = document.createElement("option");
    if ((data[i][2] == 2) && (data[i][6] == 1)) {
      option.value = data[i][0];
      option.text = data[i][1];
      // Se il valore dell'opzione è nell'array selectedValues, impostalo come selezionato
      if (eventList[0][4].includes(data[i][0])) {
        option.selected = true;
      }
      congress.appendChild(option);
    }
  }
  // Load Ingressi data[i][2]==3
  var ingressi = document.getElementById("ingressi");
  for (let i = 0; i < data.length; i++) {
    var option = document.createElement("option");
    if (data[i][2] == 3) {
      option.value = data[i][0];
      option.text = data[i][1];
      // Se il valore dell'opzione è nell'array selectedValues, impostalo come selezionato
      if (eventList[0][5].includes(data[i][0])) {
        option.selected = true;
      }
      ingressi.appendChild(option);
    }
  }
  // Load Aree data[i][2]==4
  var aree = document.getElementById("aree");
  for (let i = 0; i < data.length; i++) {
    var option = document.createElement("option");
    if (data[i][2] == 4) {
      option.value = data[i][0];
      option.text = data[i][1];
      // Se il valore dell'opzione è nell'array selectedValues, impostalo come selezionato
      if (eventList[0][6].includes(data[i][0])) {
        option.selected = true;
      }
      aree.appendChild(option);
    }
  }
  // Load Parcheggi data[i][2]==5
  var parcheggi = document.getElementById("parcheggi");
  //console.log(eventList[0][7]);
  for (let i = 0; i < data.length; i++) {
    var option = document.createElement("option");
    if (data[i][2] == 5) {
      option.value = data[i][0];
      option.text = data[i][1];
      // Se il valore dell'opzione è nell'array selectedValues, impostalo come selezionato
      if (eventList[0][7].includes(data[i][0])) {
        option.selected = true;
      }
      parcheggi.appendChild(option);
    }
  }

</script>

<!-- qui ci metto tutto ciò che riguarda la tabella con i giorni e orari di evento -->
<script>
  // Headers for the table
  // arrHead = ['', '', 'Data', 'Inizio', 'Fine', 'Fase'];
  arrHead = translate('addEventPage.tableArray').split(',');

  // formatDateInput(new date) ---> YYYY-MM-DD
  function formatDateInput(date) {
    var year = date.getFullYear();
    var month = ("0" + (date.getMonth() + 1)).slice(-2);
    var day = ("0" + date.getDate()).slice(-2);
    return year + "-" + month + "-" + day;
  }

  // formatDateInput(new date) ---> YYYY-MM-DD
  function formatHourInput(date) {
    var hours = ('0' + date.getHours()).slice(-2);
    var minutes = ('0' + date.getMinutes()).slice(-2);
    return hours + ":" + minutes;
  }

  // Create the table structure with headers
  var dataArray = []
  for (let i = 0; i < eventList.length; i++) {
    dataArray.push([eventList[i][15], eventList[i][16], eventList[i][17], eventList[i][14]]);
  }
  function createTable() {
    var empTable = document.createElement('table');
    empTable.setAttribute('id', 'empTable'); // table id.

    var tr = empTable.insertRow(-1);
    for (let h = 0; h < arrHead.length; h++) {
      var th = document.createElement('th'); // create table headers
      th.innerHTML = arrHead[h];
      tr.appendChild(th);
    }
    var div = document.getElementById('cont');
    div.appendChild(empTable);  // add the TABLE to the container.

    // Loop through data array and add rows
    for (let i = 0; i < dataArray.length; i++) {
      addRowFromData(dataArray[i]);
    }
  }

  // Add a new row to the table using data from array
  function addRowFromData(rowData) {
    var empTab = document.getElementById('empTable');
    var rowCnt = empTab.rows.length;   // table row count.
    var tr = empTab.insertRow(rowCnt); // the table row.

    //var date = new Date(dateInput);
    //var formattedDate = formatDateInput(date);
    var first = document.getElementById("startDate").value;
    var last = document.getElementById("finishDate").value;
    var min = new Date(first);
    var max = new Date(last);
    var formattedMinDate = formatDateInput(min);
    var formattedMaxDate = formatDateInput(max);
    var formattedMinHour = formatHourInput(min);
    var formattedMaxHour = formatHourInput(max);

    for (let c = 0; c < arrHead.length; c++) {
      var td = document.createElement('td'); // table definition.
      td = tr.insertCell(c);

      if (c == 0) {      // the first column.
        // add a button in every new row in the first column.
        var button = document.createElement('input');
        button.setAttribute('type', 'button');
        button.setAttribute('value', '+');
        button.setAttribute('title', translate('addEventPage.addDateBottom'));
        button.setAttribute('onclick', 'addRowFromButton(this); toggleUpdateButton()');
        td.appendChild(button);
      } else if (c == 1) {      // the second column.
        var button = document.createElement('input');
        button.setAttribute('type', 'button');
        button.setAttribute('value', '-');
        button.setAttribute('title', translate('addEventPage.removeDateBottom'));
        button.setAttribute('onclick', 'removeRow(this); toggleUpdateButton()');
        td.appendChild(button);
      } else if (c == 2) { // the third column.
        var selectDate = document.createElement("input");
        selectDate.setAttribute('type', 'date');
        selectDate.setAttribute('name', 'appt-time');
        selectDate.setAttribute('class', 'selectDate');
        selectDate.setAttribute('min', formattedMinDate);
        selectDate.setAttribute('max', formattedMaxDate);
        selectDate.setAttribute('onchange', 'toggleUpdateButton()');
        selectDate.setAttribute('value', rowData[0]);
        td.appendChild(selectDate);
      } else if (c == 3) { // the fourth column.
        var selectHour = document.createElement("input");
        selectHour.setAttribute('type', 'time');
        selectHour.setAttribute('name', 'appt-time');
        selectHour.setAttribute('class', 'selectStartHour');
        selectHour.setAttribute('onchange', 'toggleUpdateButton()');
        selectHour.setAttribute('min', formattedMinHour);
        selectHour.setAttribute('max', formattedMaxHour);
        selectHour.setAttribute('value', rowData[1]);
        td.appendChild(selectHour);

        selectHour.addEventListener('change', function (event) {
          var selectedValue = event.target.value;
          var minValue = event.target.min;
          var maxValue = event.target.max;

          // Controlla se il valore selezionato è al di fuori dell'intervallo e correggilo se necessario
          if (selectedValue < minValue) {
            event.target.value = minValue;
          } else if (selectedValue > maxValue) {
            event.target.value = maxValue;
          }
        });

      } else if (c == 4) { // the fifth column.
        var selectHour = document.createElement("input");
        selectHour.setAttribute('type', 'time');
        selectHour.setAttribute('name', 'appt-time');
        selectHour.setAttribute('class', 'selectEndHour');
        selectHour.setAttribute('onchange', 'toggleUpdateButton()');
        selectHour.setAttribute('min', formattedMinHour);
        selectHour.setAttribute('max', formattedMaxHour);
        selectHour.setAttribute('value', rowData[2]);
        td.appendChild(selectHour);

        selectHour.addEventListener('change', function (event) {
          var selectedValue = event.target.value;
          var minValue = event.target.min;
          var maxValue = event.target.max;

          // Controlla se il valore selezionato è al di fuori dell'intervallo e correggilo se necessario
          if (selectedValue < minValue) {
            event.target.value = minValue;
          } else if (selectedValue > maxValue) {
            event.target.value = maxValue;
          }
        });

      } else if (c == 5) { // the last column
        //var array = { "P": "Preallestimento", "A": "Allestimento", "E": "Evento", "D": "Disallestimento", "L": "Lavoro" };
        var stringa = translate('addEventPage.stringaArray');

        // Dividiamo la stringa in un array separandola per le virgole
        var pairs = stringa.split(',');

        // Creiamo l'oggetto partendo dall'array
        var array = {};
        for (let i = 0; i < pairs.length; i += 2) {
          array[pairs[i]] = pairs[i + 1];
        }

        var selectList = document.createElement("select");
        selectList.id = "mySelect";
        selectList.setAttribute('type', 'select');
        selectList.setAttribute('onchange', 'toggleUpdateButton()');
        td.appendChild(selectList);

        for (let key in array) {
          var option = document.createElement("option");
          option.value = key;
          option.text = array[key];
          if (key == rowData[3]) {
            option.selected = true;
          }
          selectList.appendChild(option);
        }
      }
    }
  }

  // Function to add a new row when clicking the "+" button
  function addRowFromButton(button) {
    var row = button.parentNode.parentNode; // get the current row
    var dateInput = row.querySelector("input[type='date']").value; // get the date value

    var empTab = document.getElementById('empTable');
    var rowCnt = row.rowIndex + 1; // get the selected row index and add 1 to insert below

    var date = new Date(dateInput);
    var formattedDate = formatDateInput(date);
    var first = document.getElementById("startDate").value;
    var last = document.getElementById("finishDate").value;
    var min = new Date(first);
    var max = new Date(last);
    var formattedMinDate = formatDateInput(min);
    var formattedMaxDate = formatDateInput(max);
    var formattedMinHour = formatHourInput(min);
    var formattedMaxHour = formatHourInput(max);

    var tr = empTab.insertRow(rowCnt);

    for (let c = 0; c < arrHead.length; c++) {
      var td = document.createElement('td');
      td = tr.insertCell(c);

      if (c == 0) {
        var button = document.createElement('input');
        button.setAttribute('type', 'button');
        button.setAttribute('value', '+');
        button.setAttribute('title', translate('addEventPage.addDateBottom'));
        button.setAttribute('onclick', 'addRowFromButton(this)');
        td.appendChild(button);
      } else if (c == 1) {
        var button = document.createElement('input');
        button.setAttribute('type', 'button');
        button.setAttribute('value', '-');
        button.setAttribute('title', translate('addEventPage.removeDateBottom'));
        button.setAttribute('onclick', 'removeRow(this)');
        td.appendChild(button);
      } else if (c == 2) {
        var selectDate = document.createElement("input");
        selectDate.setAttribute('type', 'date');
        selectDate.setAttribute('name', 'appt-time');
        selectDate.setAttribute('class', 'selectDate');
        selectDate.setAttribute('min', formattedMinDate);
        selectDate.setAttribute('max', formattedMaxDate);
        selectDate.setAttribute('value', formattedDate);
        td.appendChild(selectDate);
      } else if (c == 3) {
        var selectHour = document.createElement("input");
        selectHour.setAttribute('type', 'time');
        selectHour.setAttribute('name', 'appt-time');
        selectHour.setAttribute('class', 'selectStartHour');
        selectHour.setAttribute('min', formattedMinHour);
        selectHour.setAttribute('max', formattedMaxHour);
        selectHour.setAttribute('value', formattedMinHour);
        td.appendChild(selectHour);

        selectHour.addEventListener('change', function (event) {
          var selectedValue = event.target.value;
          var minValue = event.target.min;
          var maxValue = event.target.max;

          // Controlla se il valore selezionato è al di fuori dell'intervallo e correggilo se necessario
          if (selectedValue < minValue) {
            event.target.value = minValue;
          } else if (selectedValue > maxValue) {
            event.target.value = maxValue;
          }
        });

      } else if (c == 4) {
        var selectHour = document.createElement("input");
        selectHour.setAttribute('type', 'time');
        selectHour.setAttribute('name', 'appt-time');
        selectHour.setAttribute('class', 'selectEndHour');
        selectHour.setAttribute('min', formattedMinHour);
        selectHour.setAttribute('max', formattedMaxHour);
        selectHour.setAttribute('value', formattedMaxHour);
        td.appendChild(selectHour);

        selectHour.addEventListener('change', function (event) {
          var selectedValue = event.target.value;
          var minValue = event.target.min;
          var maxValue = event.target.max;

          // Controlla se il valore selezionato è al di fuori dell'intervallo e correggilo se necessario
          if (selectedValue < minValue) {
            event.target.value = minValue;
          } else if (selectedValue > maxValue) {
            event.target.value = maxValue;
          }
        });

      } else if (c == 5) {
        //var array = { "P": "Preallestimento", "A": "Allestimento", "E": "Evento", "D": "Disallestimento", "L": "Lavoro" };
        var stringa = translate('addEventPage.stringaArray');

        // Dividiamo la stringa in un array separandola per le virgole
        var pairs = stringa.split(',');

        // Creiamo l'oggetto partendo dall'array
        var array = {};
        for (let i = 0; i < pairs.length; i += 2) {
          array[pairs[i]] = pairs[i + 1];
        }

        var selectList = document.createElement("select");
        selectList.id = "mySelect";
        selectList.setAttribute('type', 'select');
        td.appendChild(selectList);

        for (let key in array) {
          var option = document.createElement("option");
          option.value = key;
          option.text = array[key];
          selectList.appendChild(option);
        }
      }
    }
  }

  // Delete row function
  function removeRow(oButton) {
    var empTab = document.getElementById('empTable');
    empTab.deleteRow(oButton.parentNode.parentNode.rowIndex); // button -> td -> tr.
  }

  // result = combineDateTime(date, startTime, endTime) --> result.startDateTime e result.endDateTime
  function combineDateTime(date, startTime, endTime) {
    // Converti la data in un oggetto Date
    let dateParts = date.split("-");
    let year = parseInt(dateParts[0], 10);
    let month = parseInt(dateParts[1], 10) - 1; // i mesi in JavaScript vanno da 0 (gennaio) a 11 (dicembre)
    let day = parseInt(dateParts[2], 10);

    // Funzione per combinare data e ora in un oggetto Date
    function getDateTime(date, time) {
      let timeParts = time.split(":");
      let hours = parseInt(timeParts[0], 10);
      let minutes = parseInt(timeParts[1], 10);
      return new Date(year, month, day, hours, minutes);
    }

    let startDateTime = getDateTime(date, startTime);
    let endDateTime = getDateTime(date, endTime);

    // Se l'ora finale è minore o uguale all'ora iniziale, aggiungi un giorno
    if (endDateTime <= startDateTime) {
      endDateTime.setDate(endDateTime.getDate() + 1);
    }

    return {
      startDateTime: startDateTime,
      endDateTime: endDateTime
    };
  }

  // Format date to YYYY-MM-DD
  function formatDateInput(date) {
    var year = date.getFullYear();
    var month = ("0" + (date.getMonth() + 1)).slice(-2);
    var day = ("0" + date.getDate()).slice(-2);
    return `${year}-${month}-${day}`;
  }


  // function to extract and submit table data.
  //var selectElementQ = document.getElementById('quartiere');
  //var selectedValuesC = Array.from(selectElementC.selectedOptions, (option) => option.value);
  //var selectedStruct = selectedValuesQ.join(', ') + ', ' + selectedValuesC.join(', ');

  function removeCommas(text) {
    // Replace all commas with an empty string
    return text.replace(/,/g, "");
  }
  function multiSelect2string(object) {
    //htmlString = document.getElementById(selectorID);
    //console.log(object.selectedOptions);
    if (object.selectedOptions.length > 0) {
      selectValues = Array.from(object.selectedOptions, (option) => option.value);
      //result = selectValues.join(', ');
      result = selectValues;
    } else {
      result = [];
    }
    return result
  }

  function randomID(length) {
    var result = '';
    var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    var charactersLength = characters.length;
    for (let i = 0; i < length; i++) {
      result += characters.charAt(Math.floor(Math.random() * charactersLength));
    }
    return result;
  }
  // console.log(randomID(2)); --> C0

  function submit() {
    var myTab = document.getElementById('empTable');
    //var arrValues = new Array();
    var finalArray = new Array();
    //var text = "";

    // loop through each row of the table.
    for (row = 1; row < myTab.rows.length; row++) {
      // loop through each cell in a row.
      for (c = 0; c < myTab.rows[row].cells.length; c++) {
        var element = myTab.rows.item(row).cells[c];
        if (element.childNodes[0].getAttribute('class') == 'selectDate') {
          //arrValues.push(element.childNodes[0].value + " [");
          //text = text + element.childNodes[0].value + " [";
          var data = element.childNodes[0].value;
        }
        else if (element.childNodes[0].getAttribute('class') == 'selectStartHour') {
          var startHour = element.childNodes[0].value;
        }
        else if (element.childNodes[0].getAttribute('class') == 'selectEndHour') {
          var endHour = element.childNodes[0].value;
        }
        else if (element.childNodes[0].getAttribute('type') == 'select') {
          if (element.childNodes[0].value.length != 0) {
            var type = element.childNodes[0].value;
          }
          //else { text = text + ', '; }
        }
      }
      result = combineDateTime(data, startHour, endHour) // --> result.startDateTime e result.endDateTime
      finalArray.push([result.startDateTime, result.endDateTime, type]);
    }


    // Populate the standard variabbles 
    var name = removeCommas(document.getElementById("name").value);
    var opz = document.getElementById("opz").value;
    var public = document.getElementById("public").value;
    var quartiere = multiSelect2string(document.getElementById('quartiere'));
    var congress = multiSelect2string(document.getElementById('congress'));
    var ingressi = multiSelect2string(document.getElementById('ingressi'));
    var aree = multiSelect2string(document.getElementById('aree'));
    var parcheggi = multiSelect2string(document.getElementById('parcheggi'));
    var refCom = document.getElementById("refCom").value;
    var refOp = document.getElementById("refOp").value;
    var typeEv = document.getElementById("typeEv").value;
    var note = removeCommas(document.getElementById("note").value);
    var org = removeCommas(document.getElementById("org").value);
    var allestitore = document.getElementById("allestitore").value;
    var catering = document.getElementById("catering").value;
    var code = document.getElementById("code").value;
    var opzExp = document.getElementById("opzExp").value;
    var vvf = document.getElementById("vvf").value;
    var cri = document.getElementById("cri").value;
    var color = document.getElementById("color").value;
    if (document.getElementById("idEvent").value) {
      var eventID = document.getElementById("idEvent").value;
    } else {
      var eventID = randomID(8);
    }

    // Check presence of one E or L in type and Create event array --> calendar(title, start Time, end Time, description, location, type, ref, eventID ()--> colorId, userEmail))
    var listEvents = new Array();
    var checkEvent = 0;
    for (let i = 0; i < finalArray.length; i++) {
      if ((finalArray[i][2] == 'E') || (finalArray[i][2] == 'L')) {
        checkEvent = 1;
      }
      var title = (opz == 'SI' ? 'Opz. ' + name : (opz == 'OFF' ? 'Off. ' + name : name)) + ' ' + finalArray[i][2];
      var description = (note.length > 0 ? note : '') + ' ' + (allestitore.length > 0 ? 'all=' + allestitore : '') + (catering.length > 0 ? ' feed=' + catering : '') + (code.length > 0 ? ' code=' + code : '') + ' id=' + eventID + ' typeEv=' + typeEv + ' org=' + org + ' refCom=' + refCom + ' refOp=' + refOp + ' open=' + public + ' ' + ((finalArray[i][2] == 'E') ? ' vvf=' + vvf + ' cri=' + cri + ' color=' + color : '') + (opzExp.length > 0 ? ' opzExp=' + opzExp : '');
      if (finalArray[i][2] == 'P') {
        var locationArray = quartiere.concat(congress, aree);
      } else {
        var locationArray = (((finalArray[i][2] == 'E') || (finalArray[i][2] == 'L')) ? quartiere.concat(congress, ingressi, aree, parcheggi) : quartiere.concat(congress, ingressi, aree));
      }
      var location = locationArray.join('| ');
      listEvents.push([title, finalArray[i][0], finalArray[i][1], description, location, finalArray[i][2], refOp, eventID]);


    }
    if (checkEvent) {
      //alert(listEvents)
      document.getElementById('output').innerHTML = listEvents;
      //alert(listEvents[0]); // da rimuovere
      return listEvents;
    } else {
      alert(<?= translate('addEventPage.addOneEventDay') ?>);
    }

  }
</script>

</html>